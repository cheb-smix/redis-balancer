# RedisBalancer
## Yii2 async caching component for more then one redis server, which increases cache availability to ~99.99%
[
    'components' => [
        'cache' => [
            'class' => 'common\components\RedisBalancer',
            'queueMode' => true,
            'lockTime' => 5,
            'interval' => 700,
            'servers' => [
                [ 'hostname' => 'localhost',    'port' => 6379, 'database' => 0 ],
                [ 'hostname' => '192.168.1.3',  'port' => 6379, 'database' => 0 ],
                [ 'hostname' => '192.168.1.5',  'port' => 6379, 'database' => 0 ],
            ],
        ],
    ],
]

// true - перемешивание массива серверов и получение значения в цикле до успешной попытки
    // false - получение значения с рандомного сервера (дефолт)
    public $queueMode = false;
    
    // вызов метода lock($key) производится вручную в скрипте
    // > 0 - лочить сеты, ждать анлока в гетах на указанное количество времени в секундах максимум (по истечении его, автоанлок)
    // 0 - забить на все
    public $lockTime = 30;
    
    // true - флаши, сеты, дели, локи происходит на всех базах, первый гет лочит значение на всех серверах, остальные геты ждут, пока первый закончит сет на все сервера
    // false - флаш происходит только на первом серваке (будем считать что это мастер или сервер меток), первый гет лочит значение на первом серваке, остальные геты пытаются получить значение с остальных серваков (в случае неудачи - ждут, пока первый закончит сет на все серваки), удаление также происходит на всех серваках. Фича может работать при наличии более одного сервера, иначе работать будет в обычном режиме мутекса.
    public $mutexMode = false;
    

    // интервал перепроверок лока в миллисекундах
    public $interval = 500;
    // сервера редиски
    public $servers = [];


    // перемешанный массив ключей массива серверов
    private $shuffledKeys = [];
    // метка перемешанности (просто $shuffledKeys может оказаться пустым, поэтому за метку не сойдет)
    private $shuffled = false;
    // выбранный источник для гет запросов (может меняться в процессе выполнения скрипта), переменная чисто для справки
    private $source = "";

    // массив залоченных текущим клиентом ключей
    private $lockedValues = [];